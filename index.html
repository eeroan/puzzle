<!DOCTYPE html>
<html>
<head>
    <title>Puzzle</title>
    <meta charset="utf-8"/>
    <style>
        body { font: 8px Arial; }
        ul { padding: 5px; }
    </style>
</head>
<body>
<ul>
    <li>Ala piirtää ylöspäin, kun pikselin väri on 7, 84, 19.</li>
    <li>Ala piirtää vasemmalle, kun pikselin väri on 139, 57, 137.</li>
    <li>Lopeta viivan piirtäminen, kun pikselin väri on 51, 69, 169.</li>
    <li>Käänny oikealle, kun pikselin väri on 182, 149, 72.</li>
    <li>Käänny vasemmalle, kun pikselin väri on 123, 131, 154.</li>
</ul>

<canvas id="canvas" width="180" height="60"></canvas>
<script>
  const width = 180
  const height = 60
  let matrix
  let ctx
  let direction //0 up, 1 right, 2 down, 3 left
  const action = rgba => {
    if (rgbEquals(rgba, [7, 84, 19])) {
      return 'up'
    } else if (rgbEquals(rgba, [139, 57, 137])) {
      return 'left'
    } else if (rgbEquals(rgba, [51, 69, 169])) {
      return 'stop'
    } else if (rgbEquals(rgba, [182, 149, 72])) {
      return 'turnRight'
    } else if (rgbEquals(rgba, [123, 131, 154])) {
      return 'turnLeft'
    } else {
      return null
    }
  }
  const rgbEquals = (rgba, rgb) =>
  rgba[0] == rgb[0] &&
  rgba[1] == rgb[1] &&
  rgba[2] == rgb[2]

  const partition = (arr, chunk) => {
    const newArr = []
    for (let i = 0, j = arr.length; i < j; i += chunk) {
      newArr.push(arr.slice(i, i + chunk))
    }
    return newArr
  }

  const penDown = (x, y) => {
    ctx.beginPath()
    ctx.moveTo(x, y)
  }
  const drawLineTo = (x, y) => {
    ctx.lineTo(x, y)
    ctx.stroke()
  }
  const stopLine = (x, y) => {
    drawLineTo(x, y)
    ctx.closePath()
    return true
  }

  const drawToDirectionWhile = (direction, x, y) => {
    switch (direction) {
    case 0:
      return upWhile(x, y)
    case 1:
      return rightWhile(x, y)
    case 2:
      return downWhile(x, y)
    case 3:
      return leftWhile(x, y)
    }
  }

  const drawAction = (x, y) => {
    let pixel = matrix[y][x]
    if (pixel === 'stop') {
      return stopLine(x, y)
    } else if (pixel === 'turnRight') {
      turnRight()
      return drawToDirectionWhile(direction, x, y)
    } else if (pixel === 'turnLeft') {
      turnLeft()
      return drawToDirectionWhile(direction, x, y)
    } else {
      return false
    }
  }

  const upWhile = (xStart, yStart) => {
    drawLineTo(xStart, yStart)
    for (let y = yStart - 1; y > 0; y--) {
      const status = drawAction(xStart, y)
      if (status) return true
    }
    return true
  }

  const downWhile = (xStart, yStart) => {
    drawLineTo(xStart, yStart)
    for (let y = yStart + 1; y < height; y++) {
      const status = drawAction(xStart, y)
      if (status) return true
    }
    return true
  }
  const leftWhile = (xStart, yStart) => {
    drawLineTo(xStart, yStart)
    for (let x = xStart - 1; x > 0; x--) {
      const status = drawAction(x, yStart)
      if (status) return true
    }
    return true
  }

  const rightWhile = (xStart, yStart) => {
    drawLineTo(xStart, yStart)
    for (let x = xStart + 1; x < width; x++) {
      const status = drawAction(x, yStart)
      if (status) return true
    }
    return true
  }

  const turnRight = () => direction = direction === 3 ? 0 : direction + 1
  const turnLeft = () => direction = direction === 0 ? 3 : direction - 1

  const myImg = new Image()
  myImg.src = 'image.png'
  myImg.onload = () => {
    ctx = document.getElementById('canvas').getContext('2d')
    ctx.drawImage(myImg, 0, 0)
    ctx.strokeStyle = "rgba(255, 0, 0, 1.0)"
    ctx.lineWidth = 2
    ctx.lineCap = "round"
    const data = Array.from(ctx.getImageData(0, 0, width, height).data)
    const pixels = partition(data, 4).map(action)
    matrix = partition(pixels, width)
    window.matrix = matrix
    for (let y = 0; y < height - 1; y++) {
      for (let x = 0; x < width - 1; x++) {
        const pixel = matrix[y][x]
        if (pixel) {
          if (pixel === 'up') {
            penDown(x, y)
            direction = 0
            upWhile(x, y)
          } else if (pixel === 'left') {
            penDown(x, y)
            direction = 2
            downWhile(x, y)
          }
        }
      }
    }
  }
</script>
</body>
</html>
