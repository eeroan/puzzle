<!DOCTYPE html>
<html>
<head>
    <title>Puzzle</title>
    <meta charset="utf-8"/>
</head>
<body>

<canvas id="canvas" width="180" height="60"></canvas>
<script>
  const width = 180
  const height = 60
  let matrix
  let ctx
  let direction //0 up, 1 right, 2 down, 3 left
  const rgbaToAction = rgba => {
    if (rgbEquals(rgba, 7, 84, 19)) return 'up'
    else if (rgbEquals(rgba, 139, 57, 137)) return 'left'
    else if (rgbEquals(rgba, 51, 69, 169)) return 'stop'
    else if (rgbEquals(rgba, 182, 149, 72)) return 'turnRight'
    else if (rgbEquals(rgba, 123, 131, 154)) return 'turnLeft'
    else return null
  }
  const rgbEquals = (rgba, r, g, b) =>
  rgba[0] === r &&
  rgba[1] === g &&
  rgba[2] === b

  const partition = (arr, chunk) => {
    const newArr = []
    for (let i = 0, j = arr.length; i < j; i += chunk) {
      newArr.push(arr.slice(i, i + chunk))
    }
    return newArr
  }

  const penDown = (x, y) => {
    ctx.beginPath()
    ctx.moveTo(x, y)
  }
  const drawLineTo = (x, y) => {
    ctx.lineTo(x, y)
    ctx.stroke()
  }
  const stopLine = (x, y) => {
    drawLineTo(x, y)
    ctx.closePath()
    return true
  }

  const turnRight = () => direction = direction === 3 ? 0 : direction + 1
  const turnLeft = () => direction = direction === 0 ? 3 : direction - 1

  const drawToDirectionWhile = (direction, x, y) => {
    drawLineTo(x, y)
    switch (direction) {
    case 0: return upWhile(x, y)
    case 1: return rightWhile(x, y)
    case 2: return downWhile(x, y)
    case 3: return leftWhile(x, y)
    }
  }

  const drawAction = (x, y) => {
    switch (matrix[y][x]) {
    case 'stop':
      return stopLine(x, y)
    case 'turnRight':
      turnRight()
      return drawToDirectionWhile(direction, x, y)
    case 'turnLeft':
      turnLeft()
      return drawToDirectionWhile(direction, x, y)
    default:
      return false
    }
  }

  const upWhile = (xStart, yStart) => {
    for (let y = yStart - 1; y > 0; y--) {
      const status = drawAction(xStart, y)
      if (status) {
        return true
      }
    }
    return true
  }

  const downWhile = (xStart, yStart) => {
    for (let y = yStart + 1; y < height; y++) {
      const status = drawAction(xStart, y)
      if (status) return true
    }
    return true
  }
  const leftWhile = (xStart, yStart) => {
    for (let x = xStart - 1; x > 0; x--) {
      const status = drawAction(x, yStart)
      if (status) return true
    }
    return true
  }

  const rightWhile = (xStart, yStart) => {
    for (let x = xStart + 1; x < width; x++) {
      const status = drawAction(x, yStart)
      if (status) return true
    }
    return true
  }

  const image = new Image()
  image.src = 'image.png'
  image.onload = () => {
    ctx = document.getElementById('canvas').getContext('2d')
    ctx.drawImage(image, 0, 0)
    ctx.strokeStyle = "rgb(255, 0, 0)"
    const pixels = partition(Array.from(ctx.getImageData(0, 0, width, height).data), 4).map(rgbaToAction)
    ctx.fillRect(0,0,width,height);
    matrix = partition(pixels, width)
    for (let y = 0; y < height - 1; y++) {
      for (let x = 0; x < width - 1; x++) {
        const pixel = matrix[y][x]
        if (pixel === 'up' || pixel === 'left') {
          penDown(x, y)
          direction = 'up' ? 0 : 2
          drawToDirectionWhile(direction, x, y)
        }
      }
    }
  }
</script>
</body>
</html>
