<!DOCTYPE html>
<html>
<head>
    <title>Puzzle</title>
    <meta charset="utf-8"/>
</head>
<body>
<canvas id="canvas" width="180" height="60"></canvas>
<script>
  const width = 180
  const height = 60
  let matrix
  let ctx
  let direction
  const image = new Image()
  image.src = 'image.png'
  image.onload = () => {
    ctx = document.getElementById('canvas').getContext('2d')
    ctx.drawImage(image, 0, 0)
    ctx.strokeStyle = "rgb(255, 0, 0)"
    ctx.lineWidth = 2
    const pixels = partition(Array.from(ctx.getImageData(0, 0, width, height).data), 4).map(rgbaToAction)
    ctx.fillRect(0, 0, width, height);
    matrix = partition(pixels, width)
    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        const pixel = matrix[y][x]
        if (pixel === 'up' || pixel === 'left') {
          start(x, y)
          draw(x, y)
        }
      }
    }
  }
  const rgbaToAction = rgba => {
    const rgbaStr = rgba.slice(0,3).join('-')
    const colorsToActions = {
      '7-84-19': 'up',
      '139-57-137': 'left',
      '51-69-169': 'stop',
      '182-149-72': 'turnRight',
      '123-131-154': 'turnLeft'
    }
    return colorsToActions[rgbaStr]
  }
  const partition = (arr, chunk) => {
    const partitioned = []
    for (let i = 0, j = arr.length; i < j; i += chunk) {
      partitioned.push(arr.slice(i, i + chunk))
    }
    return partitioned
  }
  const start = (x, y) => {
    ctx.beginPath()
    ctx.moveTo(x, y)
  }
  const drawTo = (x, y) => {
    ctx.lineTo(x, y)
    ctx.stroke()
  }
  const stop = (x, y) => {
    drawTo(x, y)
    ctx.closePath()
  }
  const draw = (x, y) => {
    const action = matrix[y][x]
    if (!action) return true
    if (action == 'stop') return stop(x, y)
    const otherActions = {
      'turnRight': () => direction = direction === 3 ? 0 : direction + 1,
      'turnLeft': () => direction = direction === 0 ? 3 : direction - 1,
      'up': () => direction = 0,
      'left': () => direction = 3
    }
    otherActions[action]()
    drawTo(x, y)
    const directionMappings = {
      0: () => {while (draw(x, --y)); },
      1: () => {while (draw(++x, y));},
      2: () => {while (draw(x, ++y));},
      3: () => {while (draw(--x, y));}
    }
    directionMappings[direction]()
  }
</script>
</body>
</html>
