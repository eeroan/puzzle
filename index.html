<!DOCTYPE html>
<html>
<head>
    <title>Puzzle</title>
    <meta charset="utf-8"/>
</head>
<body>

<canvas id="canvas" width="180" height="60"></canvas>
<script>
  const width = 180
  const height = 60
  let matrix
  let ctx
  let direction  //0 up, 1 right, 2 down, 3 left
  const rgbaToAction = rgba => {
    if (rgbEquals(rgba, 7, 84, 19)) return 'up'
    else if (rgbEquals(rgba, 139, 57, 137)) return 'left'
    else if (rgbEquals(rgba, 51, 69, 169)) return 'stop'
    else if (rgbEquals(rgba, 182, 149, 72)) return 'turnRight'
    else if (rgbEquals(rgba, 123, 131, 154)) {
      return 'turnLeft'
    } else return null
  }
  const rgbEquals = (rgba, r, g, b) =>
  rgba[0] === r &&
  rgba[1] === g &&
  rgba[2] === b

  const partition = (arr, chunk) => {
    const newArr = []
    for (let i = 0, j = arr.length; i < j; i += chunk) {
      newArr.push(arr.slice(i, i + chunk))
    }
    return newArr
  }

  const penDown = (x, y) => {
    ctx.beginPath()
    ctx.moveTo(x, y)
  }
  const drawLineTo = (x, y) => {
    ctx.lineTo(x, y)
    ctx.stroke()
  }
  const stopLine = (x, y) => {
    drawLineTo(x, y)
    ctx.closePath()
    return true
  }

  const turnRight = () => direction = direction === 3 ? 0 : direction + 1
  const turnLeft = () => direction = direction === 0 ? 3 : direction - 1

  const drawAction = (x, y) => {
    const pixel = matrix[y][x]
    if (!pixel) return false
    if (pixel == 'stop') return stopLine(x, y)
    switch (pixel) {
    case 'turnRight':
      turnRight()
      break
    case 'turnLeft':
      turnLeft()
      break
    case 'up':
      direction = 0
      break
    case 'left':
      direction = 3
    }
    return drawToDirectionWhile(direction, x, y)
  }

  const upWhile = (x, y) => {
    for (; ; y--) {
      const status = drawAction(x, y)
      if (status) return true
    }
  }

  const downWhile = (x, y) => {
    for (; ; y++) {
      const status = drawAction(x, y)
      if (status) return true
    }
  }
  const leftWhile = (x, y) => {
    for (; ; x--) {
      const status = drawAction(x, y)
      if (status) return true
    }
  }

  const rightWhile = (x, y) => {
    for (; ; x++) {
      const status = drawAction(x, y)
      if (status) return true
    }
  }

  const drawToDirectionWhile = (direction, x, y) => {
    drawLineTo(x, y)
    switch (direction) {
    case 0:
      return upWhile(x, y-1)
    case 1:
      return rightWhile(x+1, y)
    case 2:
      return downWhile(x, y+1)
    case 3:
      return leftWhile(x-1, y)
    }
  }

  const image = new Image()
  image.src = 'image.png'
  image.onload = () => {
    ctx = document.getElementById('canvas').getContext('2d')
    ctx.drawImage(image, 0, 0)
    ctx.strokeStyle = "rgb(255, 0, 0)"
    ctx.lineWidth = 2
    const pixels = partition(Array.from(ctx.getImageData(0, 0, width, height).data), 4).map(rgbaToAction)
    ctx.fillRect(0, 0, width, height);
    matrix = partition(pixels, width)
    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        const pixel = matrix[y][x]
        if (pixel === 'up' || pixel === 'left') {
          penDown(x, y)
          direction = pixel === 'up' ? 0 : 3
          drawToDirectionWhile(direction, x, y)
        }
      }
    }
  }
</script>
</body>
</html>
